{% extends 'base.html' %}
{% load bootstrap4 %}

{% block conteudo %}
<style>
.button-container {
    display: flex;
    align-items: center; /* Alinha os itens verticalmente no centro */
    gap: 10px; /* Espaçamento entre os botões */
}

.button-container .btn {
    margin-bottom: 0; /* Remove a margem inferior dos botões se necessário */
}

/* Estilo do ícone no botão */
.button-container .btn .fas {
    font-size: 1em; /* Tamanho do ícone */
}
    /* Estilo da tabela para garantir linhas visíveis */
    .table {
        border-collapse: collapse;
        width: 100%;
    }
    
    .table td,
    .table th {
        border: 1px solid #dee2e6; /* Cor das linhas da tabela */
        padding: 8px; /* Ajuste o padding conforme necessário */
    }
    
    .table td {
        text-align: center; /* Centraliza o texto dentro das células */
    }
    
    /* Estilos do botão de status */
    .status-pago,
    .status-pendente,
    .status-vencido {
        background-color: #28a745; /* Verde para pago */
        color: white;
        padding: 4px 12px; /* Aumenta o padding para um botão maior */
        border-radius: 16px; /* Borda arredondada mais pronunciada */
        text-align: center;
        display: inline-block; /* Ajusta o botão ao tamanho do texto */
        font-size: 0.875rem; /* Tamanho da fonte ajustado para um botão maior */
        white-space: nowrap; /* Impede a quebra de linha no botão */
        vertical-align: middle; /* Alinha verticalmente o botão */
    }
    
    .status-pendente {
        background-color: #fd7e14; /* Laranja para pendente */
    }
    
    .status-vencido {
        background-color: #dc3545; /* Vermelho para vencido */
    }
    .text-danger {
        color: #dc3545; /* Vermelho */
    }
    /* Adiciona rolagem horizontal para tabelas em telas pequenas */
    .table-responsive {
        overflow-x: auto;
    }
    .payment-summary {
    display: flex;
    flex-direction: row; /* Alinha os itens em uma coluna */
    align-items: center;
    justify-content: center;
    padding: 10px;
    background-color: #f9f9f9; /* Fundo claro para destacar */
    border-radius: 8px; /* Bordas arredondadas */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Sombra suave */
    margin-bottom: 20px;
    position: relative;
    overflow-x: auto;
    }

    .total-payments, .total-paid, .payments-overdue, .receivables-overdue, .payments-due-today {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        margin-top: 5px;
        position: relative; /* Necessário para posicionar o balão */
        line-height: 1.2; /* Ajusta a altura da linha para centralizar o texto */
    }

    .total-payments strong, .total-paid strong, .payments-overdue strong, .receivables-overdue strong, .payments-due-today strong {
        color: #333; /* Cor do texto forte */
        font-size: 1.1em; /* Tamanho da fonte maior para destaque */
        margin-right: 5px; /* Espaçamento entre o texto e o valor */
    }

    .amount, .amount2 {
        font-size: 1.1em; /* Tamanho da fonte igual ao texto forte */
        font-weight: bold; /* Peso da fonte em negrito */
    }

    .amount {
        color: #e74c3c; /* Cor vermelha para valores */
    }

    .amount2 {
        color: #3498db; /* Azul claro para valores de recebimentos */
    }

    .divider {
        width: 1px;
        height: 20px;
        background-color: #ddd; /* Cor da divisória */
        margin: 0 20px; /* Espaço ao redor da divisória */
    }

    /* Estilo do balão de notificação */
    .notification-balloon {
        background-color: #f39c12; /* Cor de fundo do balão */
        color: #fff; /* Cor do texto */
        padding: 2px 6px; /* Menor padding para diminuir o tamanho do balão */
        border-radius: 8px; /* Arredondamento menor */
        font-size: 0.7em; /* Tamanho menor */
        font-weight: bold;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        margin-left: 10px; /* Espaço entre o balão e o texto */
        position: absolute;
        top: -15px; /* Ajuste para posicionar o balão acima do valor */
        right: 0;
        transform: translateX(100%); /* Ajusta a posição horizontal */
        animation: blink 1s infinite; /* Adiciona a animação de piscar */
    }
    .notification-balloon-danger {
    background-color: #dc3545; /* Cor de fundo vermelha (Danger) */
    color: #fff; /* Cor do texto */
    padding: 2px 6px; /* Menor padding para diminuir o tamanho do balão */
    border-radius: 8px; /* Arredondamento menor */
    font-size: 0.7em; /* Tamanho menor */
    font-weight: bold;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    margin-left: 10px; /* Espaço entre o balão e o texto */
    position: absolute;
    top: -15px; /* Ajuste para posicionar o balão acima do valor */
    right: 0;
    transform: translateX(100%); /* Ajusta a posição horizontal */
    animation: blink 1s infinite; /* Adiciona a animação de piscar */
    }

    /* Animação de piscar */
    @keyframes blink {
        0% { opacity: 1; }
        50% { opacity: 0; }
        100% { opacity: 1; }
    }
    </style>
    <!-- Card de Próximos Pagamentos a Vencer -->
    <div class="card">
        <h3 style="margin: 10px; text-align: center">Próximos Pagamentos a vencer</h3>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th style="text-align: center; text-transform: uppercase;">Fornecedor</th>
                            <th style="text-align: center; text-transform: uppercase;">Loja</th>
                            <th style="text-align: center; text-transform: uppercase;">Centro de Custo</th>
                            <th style="text-align: center; text-transform: uppercase;">Descrição</th>
                            <th style="text-align: center; text-transform: uppercase;">Valor</th>
                            <th style="text-align: center; text-transform: uppercase;">Data de Vencimento</th>
                            <th style="text-align: center; text-transform: uppercase;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pagamento in pagamentos %}
                            <tr>
                                <td style="text-align: center;">{{ pagamento.fornecedor.nome|upper }}</td>
                                <td style="text-align: center;">{{ pagamento.loja|upper }}</td>
                                <td style="text-align: center;">{{ pagamento.centro_custo|upper }}</td>
                                <td style="text-align: center;">{{ pagamento.descricao|upper }}</td>
                                <td style="text-align: center;">{{ pagamento.valor|floatformat:2 }}</td>
                                <td style="text-align: center;" class="{% if pagamento.data_vencimento < today and pagamento.get_status_display != 'Pago' %}text-danger{% endif %}">{{ pagamento.data_vencimento }}</td>
                                <td style="text-align: center;">
                                    <span class="
                                        {% if pagamento.get_status_display == 'Pago' %}
                                            status-pago
                                        {% elif pagamento.get_status_display == 'Pendente' %}
                                            status-pendente
                                        {% elif pagamento.get_status_display == 'Vencido' %}
                                            status-vencido
                                        {% endif %}
                                    ">
                                        {{ pagamento.get_status_display|upper }}
                                    </span>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="payment-summary">
                <div class="total-payments">
                    <strong>Total de Pagamentos:</strong>
                    <span class="amount">R$ {{ total_pagamento|floatformat:2 }}</span>
                </div>
                <div class="divider"></div>
                <div class="total-paid">
                    <strong>Total Pago:</strong>
                    <span class="amount">R$ {{ total_pago|floatformat:2 }}</span>
                </div>
                <div class="divider"></div>
                <div class="payments-overdue">
                    <strong>Pagamentos Vencidos:</strong>
                    <span class="amount">R$ {{ total_pagamentos_vencidos|floatformat:2 }}</span>
                    <div class="notification-balloon-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="payments-due-today">
                    <strong>A Pagar hoje:</strong>
                    <span class="amount">R$ {{ total_pagamento_vencimento_hoje|floatformat:2 }}</span>
                    <div class="notification-balloon">Hoje</div>
                </div>
            </div>
            <!-- Container dos Botões -->
            <div class="button-container">
                <a href="{% url 'pagamentos' %}" class="btn btn-primary mb-3">
                    <span class="fas fa-eye mr-1"></span>
                    Ver todos
                </a>
                <!-- Botão para atualizar vencimentos -->
                <button type="button" class="btn btn-success mb-3" data-toggle="modal" data-target="#updateModal">
                    <span class="fas fa-sync-alt mr-2"></span>
                    Atualizar Vencimentos
                </button>
            </div>
        </div>
    </div>

    <!-- Card de Próximos Recebimentos a Vencer -->
    <div class="card">
        <h3 style="margin: 10px; text-align: center">Próximos Recebimentos a vencer</h3>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th style="text-align: center; text-transform: uppercase;">Cliente</th>
                            <th style="text-align: center; text-transform: uppercase;">Loja</th>
                            <th style="text-align: center; text-transform: uppercase;">Centro de Custo</th>
                            <th style="text-align: center; text-transform: uppercase;">Descrição</th>
                            <th style="text-align: center; text-transform: uppercase;">Valor</th>
                            <th style="text-align: center; text-transform: uppercase;">Data de Vencimento</th>
                            <th style="text-align: center; text-transform: uppercase;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for recebimento in recebimentos %}
                            <tr>
                                <td style="text-align: center;">{{ recebimento.cliente.nome|upper }}</td>
                                <td style="text-align: center;">{{ recebimento.loja|upper }}</td>
                                <td style="text-align: center;">{{ recebimento.centro_custo|upper }}</td>
                                <td style="text-align: center;">{{ recebimento.descricao|upper }}</td>
                                <td style="text-align: center;">{{ recebimento.valor|floatformat:2 }}</td>
                                <td style="text-align: center;" class="{% if recebimento.data_vencimento < today and recebimento.get_status_display != 'Pago' %}text-danger{% endif %}">{{ recebimento.data_vencimento }}</td>
                                <td style="text-align: center;">
                                    <span class="
                                        {% if recebimento.get_status_display == 'Pago' %}
                                            status-pago
                                        {% elif recebimento.get_status_display == 'Pendente' %}
                                            status-pendente
                                        {% elif recebimento.get_status_display == 'Vencido' %}
                                            status-vencido
                                        {% endif %}
                                    ">
                                        {{ recebimento.get_status_display|upper }}
                                    </span>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="payment-summary">
                <div class="total-payments">
                    <strong>Total de Recebimentos:</strong>
                    <span class="amount2">R$ {{ total_recebimento|floatformat:2 }}</span>
                </div>
                <div class="divider"></div>
                <div class="total-paid">
                    <strong>Total Recebido:</strong>
                    <span class="amount2">R$ {{ total_recebido|floatformat:2 }}</span>
                </div>
                <div class="divider"></div>
                <div class="receivables-overdue">
                    <strong>Recebimentos Vencidos:</strong>
                    <span class="amount2">R$ {{ total_recebimentos_vencidos|floatformat:2 }}</span>
                    <div class="notification-balloon-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="payments-due-today">
                    <strong>A Receber hoje:</strong>
                    <span class="amount2">R$ {{ total_recebimento_vencimento_hoje|floatformat:2 }}</span>
                    <div class="notification-balloon">Hoje</div>
                </div>
            </div>
            <a href="{% url 'recebimentos' %}" class="btn btn-primary mb-3">
                <span class="fas fa-eye mr-1"></span>
                Ver todos
            </a>
        </div>
    </div>

    <!-- Card com Resumo por Loja -->
    <div class="card">
        <h3 style="margin: 10px; text-align: center">Resumo por Loja</h3>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th style="text-align: center; text-transform: uppercase;">Loja</th>
                            <th style="text-align: center; text-transform: uppercase;">Total de Custos</th>
                            <th style="text-align: center; text-transform: uppercase;">Total de Receitas</th>
                            <th style="text-align: center; text-transform: uppercase;">Lucro Líquido</th>
                            <th style="text-align: center; text-transform: uppercase;">%</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for loja, dados in resumo_por_loja.items %}
                            <tr>
                                <td style="text-align: center;">{{ loja|upper }}</td>
                                <td style="text-align: center;">R$ {{ dados.total_custos|floatformat:2 }}</td>
                                <td style="text-align: center;">R$ {{ dados.total_receitas|floatformat:2 }}</td>
                                {% if dados.lucro_liquido >= 0 %}
                                <td style="color: blue; text-align: center;"><strong>R$ {{ dados.lucro_liquido|floatformat:2 }}</strong></td>
                                {% else %}
                                <td style="color: red; text-align: center;"><strong>R$ {{ dados.lucro_liquido|floatformat:2 }}</strong></td>
                                {% endif %}
                                <td style="text-align: center;">
                                    {% if dados.total_receitas >= 0 %}
                                        <span class="{% if dados.lucro_percentual <= 10 %}text-danger{% elif dados.lucro_percentual <= 30 %}text-warning{% elif dados.lucro_percentual <= 69.99 %}text-success{% else %}text-purple{% endif %}">
                                            <strong>{{ dados.lucro_percentual|floatformat:2 }}%</strong>
                                            {% if dados.lucro_percentual <= 10 %}
                                                <i class="fas fa-exclamation-circle"></i>
                                            {% elif dados.lucro_percentual <= 30 %}
                                                <i class="fas fa-exclamation-triangle"></i>
                                            {% elif dados.lucro_percentual <= 69.99 %}
                                                <i class="fas fa-thumbs-up"></i>
                                            {% else %}
                                                <i class="fas fa-rocket"></i>
                                            {% endif %}
                                        </span>
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                        <tr>
                            <td colspan="4" class="text-center">Nenhuma loja encontrada</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <button class="btn btn-primary mt-3" data-toggle="modal" data-target="#detalhesModal">
                Mostrar Detalhes
            </button>
            <button class="btn btn-secondary mt-3 ml-2" data-toggle="modal" data-target="#graficoModal">
                Gráfico
            </button>
        </div>
    </div>
    <!-- Modal de Confirmação -->
    <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateModalLabel">Confirmar Atualização</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Tem certeza que deseja atualizar os status dos pagamentos e recebimentos vencidos? Esta ação não pode ser desfeita.
                </div>
                <div class="modal-footer">
                    <!-- Botão Confirmar em verde -->
                    <form action="{% url 'atualizar_vencimentos' %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success">Confirmar</button>
                    </form>
                    <!-- Botão Cancelar por último -->
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal com Detalhes -->
    <div class="modal fade" id="detalhesModal" tabindex="-1" role="dialog" aria-labelledby="detalhesModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detalhesModalLabel" style="text-align: center; text-transform: uppercase;">Detalhes por Loja</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="card">
                        <h5 class="card-header" style="text-align: center; text-transform: uppercase;">Custos por Loja e Centro de Custo</h5>
                        <div class="card-body">
                            {% for loja, dados in resumo_por_loja.items %}
                                <h6 class="text-center my-3"><strong style="color: rgb(44, 89, 236);">{{ loja|upper }}</strong></h6>
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th style="text-transform: uppercase;">Centro de Custo</th>
                                            <th style="text-transform: uppercase;">Total de Custos</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for centro_custo, valor in dados.custos_por_centro.items %}
                                            <tr>
                                                <td>{{ centro_custo|upper }}</td>
                                                <td>R$ {{ valor|floatformat:2 }}</td>
                                            </tr>
                                        {% endfor %}
                                        <tr>
                                            <td><strong>Total Custos</strong></td>
                                            <td><strong style="color: red;">R$ {{ dados.total_custos|floatformat:2 }}</strong></td>
                                        </tr>
                                    </tbody>
                                </table>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="card mt-3">
                        <h5 class="card-header" style="text-align: center; text-transform: uppercase;">Receitas por Loja e Centro de Custo</h5>
                        <div class="card-body">
                            {% for loja, dados in resumo_por_loja.items %}
                                <h6 class="text-center my-3"><strong style="color: rgb(44, 89, 236);">{{ loja|upper }}</strong></h6>
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th style="text-transform: uppercase;">Centro de Custo</th>
                                            <th style="text-transform: uppercase;">Total de Receitas</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for centro_custo, valor in dados.receitas_por_centro.items %}
                                            <tr>
                                                <td>{{ centro_custo|upper }}</td>
                                                <td>R$ {{ valor|floatformat:2 }}</td>
                                            </tr>
                                        {% endfor %}
                                        <tr>
                                            <td><strong>Total Receitas</strong></td>
                                            <td><strong style="color: blue;">R$ {{ dados.total_receitas|floatformat:2 }}</strong></td>
                                        </tr>
                                    </tbody>
                                </table>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="card mt-3">
                        <h5 class="card-header" style="text-align: center; text-transform: uppercase;">Lucro Líquido por Loja</h5>
                        <div class="card-body">
                            <table class="table table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th style="text-transform: uppercase;">Loja</th>
                                        <th style="text-transform: uppercase;">Lucro Líquido</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for loja, dados in resumo_por_loja.items %}
                                        <tr>
                                            <td>{{ loja|upper }}</td>
                                            <td>R$ {{ dados.lucro_liquido|floatformat:2 }}</td>
                                        </tr>
                                    {% endfor %}
                                    <tr>
                                        {% if total_lucro_liquido >= 0 %}
                                        <td><strong style="color: blue;">Total de Lucro Lojas</strong></td>
                                        <td><strong style="color: blue;">R$ {{ total_lucro_liquido|floatformat:2 }}</strong></td>
                                        {% else %}
                                        <td><strong style="color: red;">Total de Lucro Lojas</strong></td>
                                        <td><strong style="color: red;">R$ {{ total_lucro_liquido|floatformat:2 }}</strong></td>
                                        {% endif %}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Gráficos -->
    <div class="modal fade" id="graficoModal" tabindex="-1" role="dialog" aria-labelledby="graficoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="graficoModalLabel">Gráficos de Custos e Receitas</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="pieChart"></canvas>
                        </div>
                        <div class="col-md-6">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script id="dados" type="application/json">
        {{ dados_json|safe }}
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Obtendo os dados JSON do elemento <script>
            const dadosElement = document.getElementById('dados');
            const dados = JSON.parse(dadosElement.textContent);
    
            // Extraindo dados para gráficos
            const receitas = dados.receitasPorLoja;
            const custos = dados.custosPorLoja;
            const lucroLiquido = dados.lucroLiquidoPorLoja;
    
            // Prepare os dados para o gráfico de pizza
            const labelsPie = Object.keys(receitas);
            const dataPie = labelsPie.map(loja => receitas[loja].total_receitas);
    
            // Prepare os dados para o gráfico de barras
            const labelsBar = Object.keys(lucroLiquido);
            const dataBar = labelsBar.map(loja => lucroLiquido[loja].lucro_liquido);
    
            // Gráfico de Pizza
            const ctxPie = document.getElementById('pieChart').getContext('2d');
            new Chart(ctxPie, {
                type: 'pie',
                data: {
                    labels: labelsPie,
                    datasets: [{
                        label: 'Receitas por Loja',
                        data: dataPie,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56']
                    }]
                }
            });
    
            // Gráfico de Barras
            const ctxBar = document.getElementById('barChart').getContext('2d');
            new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: labelsBar,
                    datasets: [{
                        label: 'Lucro Líquido por Loja',
                        data: dataBar,
                        backgroundColor: '#36A2EB'
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
    </script>
{% endblock %}
